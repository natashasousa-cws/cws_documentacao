{
  "$schema": "https://developer.microsoft.com/json-schemas/fabric/item/report/definition/reportExtension/1.0.0/schema.json",
  "name": "extension",
  "entities": [
    {
      "name": "Medidas",
      "measures": [
        {
          "name": "Funil clientes  2",
          "dataType": "Double",
          "expression": "\r\n-- =============================================================================================\r\n-- SEÇÃO 1: DEFINIÇÃO DAS VARIÁVEIS PRINCIPAIS\r\n-- Aqui, armazenamos as medidas base de cada etapa do funil em variáveis.\r\n-- Isso torna o código mais legível e otimizado, pois cada medida é calculada apenas uma vez.\r\n-- =============================================================================================\r\nVAR _sessoes    = [Funil - sessoes]   -- Número total de sessões que iniciam o funil.\r\nVAR _produto    = [Funil - produto]   -- Sessões que visualizaram pelo menos uma página de produto.\r\nVAR _carrinhos  = [Funil - carrinhos]  -- Sessões que adicionaram pelo menos um produto ao carrinho.\r\nVAR _frete      = [Funil - frete]     -- Sessões que chegaram à etapa de cálculo/seleção de frete.\r\nVAR _pedidos    = [Pedidos]           -- Número total de pedidos concluídos.\r\n-- =============================================================================================\r\n-- SEÇÃO 2: CÁLCULO DAS PORCENTAGENS TOTAIS (PARA AS BARRAS DE PROGRESSO)\r\n-- Esta seção calcula a porcentagem de cada etapa em relação ao número inicial de sessões (_sessoes).\r\n-- O resultado é usado para definir a LARGURA das barras de progresso no visual HTML.\r\n-- Ex: Se 50 de 100 sessões viram um produto, _pctProduto será 50%, e a barra terá 50% de largura.\r\n-- =============================================================================================\r\nVAR _pctProduto   = DIVIDE(_produto, _sessoes, 0)   -- % de sessões que viram produtos.\r\nVAR _pctCarrinhos = DIVIDE(_carrinhos, _sessoes, 0) -- % de sessões que adicionaram ao carrinho.\r\nVAR _pctFrete     = DIVIDE(_frete, _sessoes, 0)     -- % de sessões que calcularam o frete.\r\nVAR _pctPedidos   = DIVIDE(_pedidos, _sessoes, 0)   -- % de sessões que se tornaram pedidos (Taxa de Conversão).\r\n-- =============================================================================================\r\n-- SEÇÃO 3: CÁLCULO DAS REDUÇÕES (QUEDAS) ENTRE ETAPAS\r\n-- Esta seção calcula a taxa de abandono (drop-off) de uma etapa para a PRÓXIMA.\r\n-- É calculado como: 1 - (valor da etapa atual / valor da etapa ANTERIOR).\r\n-- O resultado é usado para mostrar a \"pílula\" de redução (ex: ↓ 30.0%) em cada etapa.\r\n-- =============================================================================================\r\nVAR _redProduto   = 1 - DIVIDE(_produto, _sessoes, 0)    -- Queda de \"Sessões\" para \"Visualização de Produto\".\r\nVAR _redCarrinhos = 1 - DIVIDE(_carrinhos, _produto, 0)  -- Queda de \"Visualização de Produto\" para \"Carrinho\".\r\nVAR _redFrete     = 1 - DIVIDE(_frete, _carrinhos, 0)    -- Queda de \"Carrinho\" para \"Seleção de Frete\".\r\nVAR _redPedidos   = 1 - DIVIDE(_pedidos, _frete, 0)      -- Queda de \"Seleção de Frete\" para \"Pedido Concluído\".\r\n-- =============================================================================================\r\n-- SEÇÃO 4: CÁLCULO DA TAXA DE CONVERSÃO GERAL\r\n-- Esta variável calcula a taxa de conversão final, que é o total de pedidos dividido pelo total de sessões.\r\n-- É a mesma conta de _pctPedidos, mas armazenada em uma variável com nome mais claro para ser usada no cabeçalho.\r\n-- =============================================================================================\r\nVAR _taxaConv = DIVIDE(_pedidos, _sessoes, 0)\r\n-- =============================================================================================\r\n-- SEÇÃO 5: RETORNO DO HTML\r\n-- A função RETURN constrói o visual final.\r\n-- Ela gera uma string de texto contendo código HTML e CSS.\r\n-- As variáveis DAX calculadas acima são inseridas no HTML usando o operador de concatenação \"&\".\r\n-- =============================================================================================\r\nRETURN\r\n\"<!DOCTYPE html>\r\n<html lang='pt-br'>\r\n<head>\r\n<meta charset='UTF-8'>\r\n<style>\r\n/* CSS para estilizar o funil. Tudo está contido aqui para que o visual seja autônomo. */\r\nbody { font-family:'Segoe UI',Tahoma,sans-serif; background:#fff; margin:0; padding:8px; color:#333; max-width:830px; box-sizing:border-box;}\r\nh1 { font-size:18px; margin:0 0 8px 0; font-weight:600; color:#202124;}\r\n.total-conversion-box { background:#f6f0fb; border:1px solid #DCD1E6; border-radius:6px; padding:6px 12px; display:inline-block;}\r\n.total-conversion-rate { font-size:14px; font-weight:700; color:#7b1fa2;}\r\n.funnel-step { width:100%; margin-bottom:8px; padding:8px; border-radius:6px; transition: background-color 0.2s ease-in-out;}\r\n.funnel-step:hover { background-color: #F9F9F9; }\r\n.step-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;}\r\n.step-title-group { display:flex; align-items:center; gap:8px; font-size:14px; font-weight:600; color:#333;}\r\n.step-icon { width:16px; height:16px; fill:#7b1fa2;}\r\n.step-value-text { font-size:13px; font-weight:700; color:#202124;}\r\n.step-reduction-pill { background:#fff9c4; color:#613c00; border:1px solid #F9E69A; padding:1px 6px; border-radius:10px; font-size:12px; font-weight:600;}\r\n.progress-container { display:flex; align-items:center; gap:8px; }\r\n.progress-bar-background { height:18px; background:#f1f3f4; border-radius:4px; overflow:hidden; flex-grow:1; border:1px solid #E0E0E0;}\r\n.progress-label { font-size:13px; font-weight:700; color:#202124; width:45px; text-align:right; }\r\n.funnel-bar { height:100%; border-radius:3px; }\r\n.sessoes .funnel-bar { background:linear-gradient(90deg,#50005C,#73175C);}\r\n.visualizados .funnel-bar { background:linear-gradient(90deg,#73175C,#9E1E7F);}\r\n.carrinhos .funnel-bar { background:linear-gradient(90deg,#9E1E7F,#A666B0);}\r\n.frete .funnel-bar { background:linear-gradient(90deg,#A666B0,#C499CA);}\r\n.concluido .funnel-bar { background:linear-gradient(90deg,#388E3C,#66BB6A);}\r\n</style>\r\n</head>\r\n<body>\r\n<div class='container'>\r\n  <div class='header'>\r\n    <h1>Funil de Conversão do Cliente</h1>\r\n    <div class='total-conversion-box'>\r\n      <div class='total-conversion-rate'>Taxa de Conversão Total: \" & FORMAT(_taxaConv,\"0.0%\") & \"</div>\r\n    </div>\r\n  </div>\r\n  <div class='funnel-step sessoes'>\r\n    <div class='step-header'>\r\n      <div class='step-title-group'>\r\n        <svg class='step-icon' viewBox='0 0 24 24'><path d='M13.5,4A1.5,1.5 0 0,0 12,5.5A1.5,1.5 0 0,0 13.5,7A1.5,1.5 0 0,0 15,5.5A1.5,1.5 0 0,0 13.5,4M10.5,10.94L7.5,7.94L6.44,9L10.5,13.06L12.94,10.62L17.5,15.18L18.91,13.76L12.94,7.8L10.5,10.18V10.94M4,2H20A2,2 0 0,1 22,4V20A2,2 0 0,1 20,22H4A2,2 0 0,1 2,20V4A2,2 0 0,1 4,2Z' /></svg>\r\n        <span>Sessões</span>\r\n      </div>\r\n      <span class='step-value-text'>\" & FORMAT(_sessoes,\"#,##0\") & \"</span>\r\n    </div>\r\n    <div class='progress-container'>\r\n      <div class='progress-bar-background'>\r\n        <div class='funnel-bar' style='width:100%;'></div>\r\n      </div>\r\n      <span class='progress-label'>100%</span>\r\n    </div>\r\n  </div>\r\n  <div class='funnel-step visualizados'>\r\n  <div class='step-header'>\r\n    <div class='step-title-group'>\r\n      <svg class='step-icon' viewBox='0 0 24 24'><path d='M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z'/></svg>\r\n      <span>Produtos Visualizados</span>\r\n      <span class='step-reduction-pill'>↓ \" & FORMAT(_redProduto,\"0.0%\") & \"</span>\r\n    </div>\r\n    <span class='step-value-text'>\" & FORMAT(_produto,\"#,##0\") & \"</span>\r\n  </div>\r\n  <div class='progress-container'>\r\n    <div class='progress-bar-background'>\r\n      <div class='funnel-bar' style='width:\" & FORMAT(_pctProduto,\"0%\") & \";'></div>\r\n    </div>\r\n    <span class='progress-label'>\" & FORMAT(_pctProduto,\"0.0%\") & \"</span>\r\n  </div>\r\n</div>\r\n<div class='funnel-step carrinhos'>\r\n  <div class='step-header'>\r\n    <div class='step-title-group'>\r\n      <svg class='step-icon' viewBox='0 0 24 24'><path d='M17,18A2,2 0 0,1 19,20A2,2 0 0,1 17,22A2,2 0 0,1 15,20A2,2 0 0,1 17,18M1,2V4H3L6.6,11.59L5.24,14.04C5.09,14.32 5,14.65 5,15A2,2 0 0,0 7,17H19V15H7.42A0.25,0.25 0 0,1 7.17,14.75L8.1,13H15.55C16.3,13 16.96,12.58 17.3,11.97L20.88,5.5C20.95,5.34 21,5.17 21,5A1,1 0 0,0 20,4H5.21L4.27,2H1M7,18A2,2 0 0,1 9,20A2,2 0 0,1 7,22A2,2 0 0,1 5,20A2,2 0 0,1 7,18Z'/></svg>\r\n      <span>Carrinhos</span>\r\n      <span class='step-reduction-pill'>↓ \" & FORMAT(_redCarrinhos,\"0.0%\") & \"</span>\r\n    </div>\r\n    <span class='step-value-text'>\" & FORMAT(_carrinhos,\"#,##0\") & \"</span>\r\n  </div>\r\n  <div class='progress-container'>\r\n    <div class='progress-bar-background'>\r\n      <div class='funnel-bar' style='width:\" & FORMAT(_pctCarrinhos,\"0%\") & \";'></div>\r\n    </div>\r\n    <span class='progress-label'>\" & FORMAT(_pctCarrinhos,\"0.0%\") & \"</span>\r\n  </div>\r\n</div>\r\n<div class='funnel-step frete'>\r\n  <div class='step-header'>\r\n    <div class='step-title-group'>\r\n      <svg class='step-icon' viewBox='0 0 24 24'><path d='M3,4A2,2 0 0,0 1,6V17H3A3,3 0 0,0 6,20A3,3 0 0,0 9,17H15A3,3 0 0,0 18,20A3,3 0 0,0 21,17H23V12L20,8H17V4H3M17,9.5H19.5L21.47,12H17V9.5M6,15.5A1.5,1.5 0 0,1 7.5,17A1.5,1.5 0 0,1 6,18.5A1.5,1.5 0 0,1 4.5,17A1.5,1.5 0 0,1 6,15.5M18,15.5A1.5,1.5 0 0,1 19.5,17A1.5,1.5 0 0,1 18,18.5A1.5,1.5 0 0,1 16.5,17A1.5,1.5 0 0,1 18,15.5Z'/></svg>\r\n      <span>Frete Selecionado</span>\r\n      <span class='step-reduction-pill'>↓ \" & FORMAT(_redFrete,\"0.0%\") & \"</span>\r\n    </div>\r\n    <span class='step-value-text'>\" & FORMAT(_frete,\"#,##0\") & \"</span>\r\n  </div>\r\n  <div class='progress-container'>\r\n    <div class='progress-bar-background'>\r\n      <div class='funnel-bar' style='width:\" & FORMAT(_pctFrete,\"0%\") & \";'></div>\r\n    </div>\r\n    <span class='progress-label'>\" & FORMAT(_pctFrete,\"0.0%\") & \"</span>\r\n  </div>\r\n</div>\r\n<div class='funnel-step concluido'>\r\n  <div class='step-header'>\r\n    <div class='step-title-group'>\r\n      <svg class='step-icon' fill='#388E3C' viewBox='0 0 24 24'><path d='M12 2C6.5 2 2 6.5 2 12S6.5 22 12 22 22 17.5 22 12 17.5 2 12 2M10 17L5 12L6.41 10.59L10 14.17L17.59 6.58L19 8L10 17Z'/></svg>\r\n      <span>Pedido Concluído</span>\r\n      <span class='step-reduction-pill'>↓ \" & FORMAT(_redPedidos,\"0.0%\") & \"</span>\r\n    </div>\r\n    <span class='step-value-text'>\" & FORMAT(_pedidos,\"#,##0\") & \"</span>\r\n  </div>\r\n  <div class='progress-container'>\r\n    <div class='progress-bar-background'>\r\n      <div class='funnel-bar' style='width:\" & FORMAT(_pctPedidos,\"0%\") & \";'></div>\r\n    </div>\r\n    <span class='progress-label'>\" & FORMAT(_pctPedidos,\"0.0%\") & \"</span>\r\n  </div>\r\n</div>\r\n</div>\r\n</body>\r\n</html>\"",
          "formatString": "General Number",
          "references": {
            "measures": [
              {
                "entity": "Medidas",
                "name": "Funil - sessoes"
              },
              {
                "entity": "Medidas",
                "name": "Funil - produto"
              },
              {
                "entity": "Medidas",
                "name": "Funil - carrinhos"
              },
              {
                "entity": "Medidas",
                "name": "Funil - frete"
              },
              {
                "entity": "Medidas",
                "name": "Pedidos"
              }
            ]
          }
        }
      ]
    }
  ]
}