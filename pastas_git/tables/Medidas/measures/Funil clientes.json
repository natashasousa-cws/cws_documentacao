{
  "name": "Funil clientes",
  "expression": [
    "",
    "-- =============================================================================================",
    "-- SEÇÃO 1: DEFINIÇÃO DAS VARIÁVEIS PRINCIPAIS",
    "-- Aqui, armazenamos as medidas base de cada etapa do funil em variáveis.",
    "-- Isso torna o código mais legível e otimizado, pois cada medida é calculada apenas uma vez.",
    "-- =============================================================================================",
    "VAR _sessoes    = [Funil - sessoes]   -- Número total de sessões que iniciam o funil.",
    "VAR _produto    = [Funil - produto]   -- Sessões que visualizaram pelo menos uma página de produto.",
    "VAR _carrinhos  = [Funil - carrinhos]  -- Sessões que adicionaram pelo menos um produto ao carrinho.",
    "VAR _frete      = [Funil - frete]     -- Sessões que chegaram à etapa de cálculo/seleção de frete.",
    "VAR _pedidos    = [Funil - pedido]           -- Número total de pedidos concluídos.",
    "-- =============================================================================================",
    "-- SEÇÃO 2: CÁLCULO DAS PORCENTAGENS TOTAIS (PARA AS BARRAS DE PROGRESSO)",
    "-- Esta seção calcula a porcentagem de cada etapa em relação ao número inicial de sessões (_sessoes).",
    "-- O resultado é usado para definir a LARGURA das barras de progresso no visual HTML.",
    "-- Ex: Se 50 de 100 sessões viram um produto, _pctProduto será 50%, e a barra terá 50% de largura.",
    "-- =============================================================================================",
    "VAR _pctProduto   = DIVIDE(_produto, _sessoes, 0)   -- % de sessões que viram produtos.",
    "VAR _pctCarrinhos = DIVIDE(_carrinhos, _sessoes, 0) -- % de sessões que adicionaram ao carrinho.",
    "VAR _pctFrete     = DIVIDE(_frete, _sessoes, 0)     -- % de sessões que calcularam o frete.",
    "VAR _pctPedidos   = DIVIDE(_pedidos, _sessoes, 0)   -- % de sessões que se tornaram pedidos (Taxa de Conversão).",
    "-- =============================================================================================",
    "-- SEÇÃO 3: CÁLCULO DAS REDUÇÕES (QUEDAS) ENTRE ETAPAS",
    "-- Esta seção calcula a taxa de abandono (drop-off) de uma etapa para a PRÓXIMA.",
    "-- É calculado como: 1 - (valor da etapa atual / valor da etapa ANTERIOR).",
    "-- O resultado é usado para mostrar a \"pílula\" de redução (ex: ↓ 30.0%) em cada etapa.",
    "-- =============================================================================================",
    "VAR _redProduto   = 1 - DIVIDE(_produto, _sessoes, 0)    -- Queda de \"Sessões\" para \"Visualização de Produto\".",
    "VAR _redCarrinhos = 1 - DIVIDE(_carrinhos, _produto, 0)  -- Queda de \"Visualização de Produto\" para \"Carrinho\".",
    "VAR _redFrete     = 1 - DIVIDE(_frete, _carrinhos, 0)    -- Queda de \"Carrinho\" para \"Seleção de Frete\".",
    "VAR _redPedidos   = 1 - DIVIDE(_pedidos, _frete, 0)      -- Queda de \"Seleção de Frete\" para \"Pedido Concluído\".",
    "-- =============================================================================================",
    "-- SEÇÃO 4: CÁLCULO DA TAXA DE CONVERSÃO GERAL",
    "-- Esta variável calcula a taxa de conversão final, que é o total de pedidos dividido pelo total de sessões.",
    "-- É a mesma conta de _pctPedidos, mas armazenada em uma variável com nome mais claro para ser usada no cabeçalho.",
    "-- =============================================================================================",
    "VAR _taxaConv = DIVIDE(_pedidos, _sessoes, 0)",
    "-- =============================================================================================",
    "-- SEÇÃO 5: RETORNO DO HTML",
    "-- A função RETURN constrói o visual final.",
    "-- Ela gera uma string de texto contendo código HTML e CSS.",
    "-- As variáveis DAX calculadas acima são inseridas no HTML usando o operador de concatenação \"&\".",
    "-- =============================================================================================",
    "RETURN",
    "\"<!DOCTYPE html>",
    "<html lang='pt-br'>",
    "<head>",
    "<meta charset='UTF-8'>",
    "<style>",
    "/* CSS para estilizar o funil. Tudo está contido aqui para que o visual seja autônomo. */",
    "body { font-family:'Segoe UI',Tahoma,sans-serif; background:#fff; margin:0; padding:8px; color:#333; max-width:830px; box-sizing:border-box;}",
    "h1 { font-size:18px; margin:0 0 8px 0; font-weight:600; color:#202124;}",
    ".total-conversion-box { background:#f6f0fb; border:1px solid #DCD1E6; border-radius:6px; padding:6px 12px; display:inline-block;}",
    ".total-conversion-rate { font-size:14px; font-weight:700; color:#7b1fa2;}",
    ".funnel-step { width:100%; margin-bottom:8px; padding:8px; border-radius:6px; transition: background-color 0.2s ease-in-out;}",
    ".funnel-step:hover { background-color: #F9F9F9; }",
    ".step-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;}",
    ".step-title-group { display:flex; align-items:center; gap:8px; font-size:14px; font-weight:600; color:#333;}",
    ".step-icon { width:16px; height:16px; fill:#7b1fa2;}",
    ".step-value-text { font-size:13px; font-weight:700; color:#202124;}",
    ".step-reduction-pill { background:#fff9c4; color:#613c00; border:1px solid #F9E69A; padding:1px 6px; border-radius:10px; font-size:12px; font-weight:600;}",
    ".progress-container { display:flex; align-items:center; gap:8px; }",
    ".progress-bar-background { height:18px; background:#f1f3f4; border-radius:4px; overflow:hidden; flex-grow:1; border:1px solid #E0E0E0;}",
    ".progress-label { font-size:13px; font-weight:700; color:#202124; width:45px; text-align:right; }",
    ".funnel-bar { height:100%; border-radius:3px; }",
    ".sessoes .funnel-bar { background:linear-gradient(90deg,#50005C,#73175C);}",
    ".visualizados .funnel-bar { background:linear-gradient(90deg,#73175C,#9E1E7F);}",
    ".carrinhos .funnel-bar { background:linear-gradient(90deg,#9E1E7F,#A666B0);}",
    ".frete .funnel-bar { background:linear-gradient(90deg,#A666B0,#C499CA);}",
    ".concluido .funnel-bar { background:linear-gradient(90deg,#388E3C,#66BB6A);}",
    "</style>",
    "</head>",
    "<body>",
    "<div class='container'>",
    "  <div class='header'>",
    "    <h1>Funil de Conversão do Cliente</h1>",
    "    <div class='total-conversion-box'>",
    "      <div class='total-conversion-rate'>Taxa de Conversão Total: \" & FORMAT(_taxaConv,\"0.0%\") & \"</div>",
    "    </div>",
    "  </div>",
    "  <div class='funnel-step sessoes'>",
    "    <div class='step-header'>",
    "      <div class='step-title-group'>",
    "        <svg class='step-icon' viewBox='0 0 24 24'><path d='M13.5,4A1.5,1.5 0 0,0 12,5.5A1.5,1.5 0 0,0 13.5,7A1.5,1.5 0 0,0 15,5.5A1.5,1.5 0 0,0 13.5,4M10.5,10.94L7.5,7.94L6.44,9L10.5,13.06L12.94,10.62L17.5,15.18L18.91,13.76L12.94,7.8L10.5,10.18V10.94M4,2H20A2,2 0 0,1 22,4V20A2,2 0 0,1 20,22H4A2,2 0 0,1 2,20V4A2,2 0 0,1 4,2Z' /></svg>",
    "        <span>Sessões</span>",
    "      </div>",
    "      <span class='step-value-text'>\" & FORMAT(_sessoes,\"#,##0\") & \"</span>",
    "    </div>",
    "    <div class='progress-container'>",
    "      <div class='progress-bar-background'>",
    "        <div class='funnel-bar' style='width:100%;'></div>",
    "      </div>",
    "      <span class='progress-label'>100%</span>",
    "    </div>",
    "  </div>",
    "  <div class='funnel-step visualizados'>",
    "  <div class='step-header'>",
    "    <div class='step-title-group'>",
    "      <svg class='step-icon' viewBox='0 0 24 24'><path d='M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z'/></svg>",
    "      <span>Produtos Visualizados</span>",
    "      <span class='step-reduction-pill'>↓ \" & FORMAT(_redProduto,\"0.0%\") & \"</span>",
    "    </div>",
    "    <span class='step-value-text'>\" & FORMAT(_produto,\"#,##0\") & \"</span>",
    "  </div>",
    "  <div class='progress-container'>",
    "    <div class='progress-bar-background'>",
    "      <div class='funnel-bar' style='width:\" & FORMAT(_pctProduto,\"0%\") & \";'></div>",
    "    </div>",
    "    <span class='progress-label'>\" & FORMAT(_pctProduto,\"0.0%\") & \"</span>",
    "  </div>",
    "</div>",
    "<div class='funnel-step carrinhos'>",
    "  <div class='step-header'>",
    "    <div class='step-title-group'>",
    "      <svg class='step-icon' viewBox='0 0 24 24'><path d='M17,18A2,2 0 0,1 19,20A2,2 0 0,1 17,22A2,2 0 0,1 15,20A2,2 0 0,1 17,18M1,2V4H3L6.6,11.59L5.24,14.04C5.09,14.32 5,14.65 5,15A2,2 0 0,0 7,17H19V15H7.42A0.25,0.25 0 0,1 7.17,14.75L8.1,13H15.55C16.3,13 16.96,12.58 17.3,11.97L20.88,5.5C20.95,5.34 21,5.17 21,5A1,1 0 0,0 20,4H5.21L4.27,2H1M7,18A2,2 0 0,1 9,20A2,2 0 0,1 7,22A2,2 0 0,1 5,20A2,2 0 0,1 7,18Z'/></svg>",
    "      <span>Carrinhos</span>",
    "      <span class='step-reduction-pill'>↓ \" & FORMAT(_redCarrinhos,\"0.0%\") & \"</span>",
    "    </div>",
    "    <span class='step-value-text'>\" & FORMAT(_carrinhos,\"#,##0\") & \"</span>",
    "  </div>",
    "  <div class='progress-container'>",
    "    <div class='progress-bar-background'>",
    "      <div class='funnel-bar' style='width:\" & FORMAT(_pctCarrinhos,\"0%\") & \";'></div>",
    "    </div>",
    "    <span class='progress-label'>\" & FORMAT(_pctCarrinhos,\"0.0%\") & \"</span>",
    "  </div>",
    "</div>",
    "<div class='funnel-step frete'>",
    "  <div class='step-header'>",
    "    <div class='step-title-group'>",
    "      <svg class='step-icon' viewBox='0 0 24 24'><path d='M3,4A2,2 0 0,0 1,6V17H3A3,3 0 0,0 6,20A3,3 0 0,0 9,17H15A3,3 0 0,0 18,20A3,3 0 0,0 21,17H23V12L20,8H17V4H3M17,9.5H19.5L21.47,12H17V9.5M6,15.5A1.5,1.5 0 0,1 7.5,17A1.5,1.5 0 0,1 6,18.5A1.5,1.5 0 0,1 4.5,17A1.5,1.5 0 0,1 6,15.5M18,15.5A1.5,1.5 0 0,1 19.5,17A1.5,1.5 0 0,1 18,18.5A1.5,1.5 0 0,1 16.5,17A1.5,1.5 0 0,1 18,15.5Z'/></svg>",
    "      <span>Frete Selecionado</span>",
    "      <span class='step-reduction-pill'>↓ \" & FORMAT(_redFrete,\"0.0%\") & \"</span>",
    "    </div>",
    "    <span class='step-value-text'>\" & FORMAT(_frete,\"#,##0\") & \"</span>",
    "  </div>",
    "  <div class='progress-container'>",
    "    <div class='progress-bar-background'>",
    "      <div class='funnel-bar' style='width:\" & FORMAT(_pctFrete,\"0%\") & \";'></div>",
    "    </div>",
    "    <span class='progress-label'>\" & FORMAT(_pctFrete,\"0.0%\") & \"</span>",
    "  </div>",
    "</div>",
    "<div class='funnel-step concluido'>",
    "  <div class='step-header'>",
    "    <div class='step-title-group'>",
    "      <svg class='step-icon' fill='#388E3C' viewBox='0 0 24 24'><path d='M12 2C6.5 2 2 6.5 2 12S6.5 22 12 22 22 17.5 22 12 17.5 2 12 2M10 17L5 12L6.41 10.59L10 14.17L17.59 6.58L19 8L10 17Z'/></svg>",
    "      <span>Pedido Concluído</span>",
    "      <span class='step-reduction-pill'>↓ \" & FORMAT(_redPedidos,\"0.0%\") & \"</span>",
    "    </div>",
    "    <span class='step-value-text'>\" & FORMAT(_pedidos,\"#,##0\") & \"</span>",
    "  </div>",
    "  <div class='progress-container'>",
    "    <div class='progress-bar-background'>",
    "      <div class='funnel-bar' style='width:\" & FORMAT(_pctPedidos,\"0%\") & \";'></div>",
    "    </div>",
    "    <span class='progress-label'>\" & FORMAT(_pctPedidos,\"0.0%\") & \"</span>",
    "  </div>",
    "</div>",
    "</div>",
    "</body>",
    "</html>\""
  ],
  "displayFolder": "Visuais HTML",
  "lineageTag": "e5438922-6d00-4614-9b52-692b911ab6c2"
}